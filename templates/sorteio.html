{% extends "base.html" %}

{% block title %}Sorteio - {{ grupo.nome }}{% endblock %}

{% block content %}
<div class="sorteio-container">
    <div class="sorteio-header">
        <h1><i class="fas fa-random"></i> Sorteio {{ sorteio.ano }}</h1>
        <a href="{{ url_for('ver_grupo', grupo_id=grupo.id) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar ao Grupo
        </a>
    </div>

    <div class="revelacao-roleta">
        <div class="roleta-container">
            <div class="roleta" id="roleta">
                <div class="roleta-texto">Girando...</div>
            </div>
            <button onclick="girarRoleta()" class="btn btn-success btn-lg">
                <i class="fas fa-redo"></i> Girar Roleta
            </button>
        </div>

        <div class="amigo-info card">
            <h2><i class="fas fa-user-secret"></i> Seu Amigo Secreto</h2>
            <div class="amigo-detalhes">
                <div class="amigo-avatar">{{ amigo_secreto.nome[0]|upper }}</div>
                <div class="amigo-texto">
                    <h3>{{ amigo_secreto.nome }}</h3>
                    <p><i class="fas fa-envelope"></i> {{ amigo_secreto.email }}</p>
                    <p><i class="fas fa-calendar"></i> Sorteio realizado em: {{ sorteio.data_sorteio.strftime('%d/%m/%Y %H:%M') }}</p>
                </div>
            </div>

            <div class="amigo-dicas">
                <h3><i class="fas fa-lightbulb"></i> Dicas para Presentear</h3>
                {% if grupo.descricao %}
                <p><strong>Sobre o evento:</strong> {{ grupo.descricao }}</p>
                {% endif %}

                {% if grupo.valor_minimo and grupo.valor_maximo %}
                <p><strong>Valor sugerido:</strong> R$ {{ grupo.valor_minimo }} - R$ {{ grupo.valor_maximo }}</p>
                {% endif %}

                {% if grupo.local_evento %}
                <p><strong>Local do evento:</strong> {{ grupo.local_evento }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sugestões de presentes do amigo -->
    <div class="card">
        <h2><i class="fas fa-gifts"></i> Sugestões do {{ amigo_secreto.nome }}</h2>
        <div id="sugestoesAmigo" class="presentes-list">
            <p>Carregando sugestões...</p>
        </div>
    </div>

    <!-- Mensagens para o amigo -->
    <div class="card">
        <h2><i class="fas fa-comments"></i> Enviar Mensagem para {{ amigo_secreto.nome }}</h2>
        <form id="mensagemForm" class="mensagem-form">
            <textarea name="conteudo" placeholder="Envie uma dica, sugestão ou recado para seu amigo secreto..." required></textarea>
            <div class="form-check">
                <input type="checkbox" name="anonima" id="anonima" checked>
                <label for="anonima">Enviar como anônimo</label>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i> Enviar Mensagem
            </button>
        </form>
    </div>
</div>

<script>
const nomes = [
    "{{ amigo_secreto.nome }}",
    "???",
    "Quem será?",
    "Girando...",
    "{{ amigo_secreto.nome[:3] }}..."
];

function girarRoleta() {
    const roleta = document.getElementById('roleta');
    const texto = roleta.querySelector('.roleta-texto');

    roleta.classList.add('girando');
    texto.textContent = "Girando...";

    let contador = 0;
    const intervalo = setInterval(() => {
        texto.textContent = nomes[contador % nomes.length];
        contador++;
    }, 100);

    setTimeout(() => {
        clearInterval(intervalo);
        roleta.classList.remove('girando');
        texto.textContent = "{{ amigo_secreto.nome }}";
        texto.classList.add('revelado');
    }, 3000);
}

// Carregar sugestões do amigo
fetch(`/api/sugestoes/{{ amigo_secreto.id }}/{{ grupo.id }}`)
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('sugestoesAmigo');
        if (data.sugestoes && data.sugestoes.length > 0) {
            container.innerHTML = data.sugestoes.map(sugestao => `
                <div class="presente-item">
                    <div class="presente-info">
                        <h4>${sugestao.descricao}</h4>
                        ${sugestao.link ? `<a href="${sugestao.link}" target="_blank" class="presente-link">
                            <i class="fas fa-external-link-alt"></i> Ver link
                        </a>` : ''}
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<p class="empty">Seu amigo ainda não adicionou sugestões de presentes.</p>';
        }
    });

// Enviar mensagem
document.getElementById('mensagemForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    formData.append('destinatario_id', '{{ amigo_secreto.id }}');

    fetch("{{ url_for('enviar_mensagem', grupo_id=grupo.id) }}", {
        method: 'POST',
        body: formData
    }).then(response => response.json())
      .then(data => {
          if (data.success) {
              alert('Mensagem enviada com sucesso!');
              this.reset();
          }
      });
});

// Iniciar roleta automaticamente
setTimeout(girarRoleta, 1000);
</script>
{% endblock %}
