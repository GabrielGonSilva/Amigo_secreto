{% extends "base.html" %}

{% block title %}{{ grupo.nome }} - Amigo Secreto{% endblock %}

{% block content %}
<div class="grupo-container">
    <!-- Cabeçalho do Grupo -->
    <div class="grupo-header">
        <h1><i class="fas fa-users"></i> {{ grupo.nome }}</h1>
        <div class="grupo-actions">
            <span class="codigo-grupo">
                <i class="fas fa-key"></i> Código: <strong>{{ grupo.codigo_acesso }}</strong>
                <button onclick="copiarCodigo('{{ grupo.codigo_acesso }}')" class="btn-copiar" title="Copiar código">
                    <i class="fas fa-copy"></i>
                </button>
            </span>
            {% if grupo.admin_id == current_user.id %}
            <span class="badge badge-admin">
                <i class="fas fa-crown"></i> Administrador
            </span>
            {% endif %}
        </div>
    </div>

    <!-- Informações do Evento -->
    <div class="grupo-info card">
        <h2><i class="fas fa-info-circle"></i> Informações do Evento</h2>
        <div class="info-grid">
            <div class="info-item">
                <i class="fas fa-calendar"></i>
                <div>
                    <strong>Data</strong>
                    <p>{{ grupo.data_evento.strftime('%d/%m/%Y %H:%M') if grupo.data_evento else 'Não definida' }}</p>
                </div>
            </div>
            <div class="info-item">
                <i class="fas fa-map-marker-alt"></i>
                <div>
                    <strong>Local</strong>
                    <p>{{ grupo.local_evento or 'Não definido' }}</p>
                </div>
            </div>
            <div class="info-item">
                <i class="fas fa-money-bill-wave"></i>
                <div>
                    <strong>Valor</strong>
                    <p>
                        {% if grupo.valor_minimo and grupo.valor_maximo %}
                            R$ {{ grupo.valor_minimo }} - R$ {{ grupo.valor_maximo }}
                        {% else %}
                            Não definido
                        {% endif %}
                    </p>
                </div>
            </div>
            <div class="info-item">
                <i class="fas fa-user-crown"></i>
                <div>
                    <strong>Admin</strong>
                    <p>{{ grupo.admin.nome }}</p>
                </div>
            </div>
        </div>

        {% if grupo.descricao %}
        <div class="descricao-grupo">
            <h3><i class="fas fa-file-alt"></i> Descrição</h3>
            <p>{{ grupo.descricao }}</p>
        </div>
        {% endif %}
    </div>

    <!-- Status do Meu Sorteio -->
    {% if ja_sorteou %}
    <div class="card meu-sorteio-status">
        <div class="sorteio-status-header">
            <h2><i class="fas fa-check-circle text-success"></i> Seu Sorteio Realizado</h2>
            <span class="status-badge status-realizado">
                <i class="fas fa-gift"></i> Sorteio Concluído
            </span>
        </div>
        <div class="sorteio-status-content">
            <p>Você já realizou o sorteio do amigo secreto!</p>
            <div class="acoes-sorteio">
                <a href="{{ url_for('ver_meu_sorteio', token=SorteioIndividual.query.filter_by(usuario_id=current_user.id, grupo_id=grupo.id).first().token_acesso) }}"
                   class="btn btn-primary">
                    <i class="fas fa-eye"></i> Ver Meu Amigo Secreto
                </a>
                <a href="{{ url_for('lista_sugestoes', grupo_id=grupo.id) }}" class="btn btn-secondary">
                    <i class="fas fa-gifts"></i> Ver Sugestões
                </a>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card meu-sorteio-status">
        <div class="sorteio-status-header">
            <h2><i class="fas fa-hourglass-half text-warning"></i> Seu Sorteio Pendente</h2>
            <span class="status-badge status-pendente">
                <i class="fas fa-clock"></i> Aguardando
            </span>
        </div>
        <div class="sorteio-status-content">
            <p>Você ainda não realizou o sorteio do amigo secreto.</p>
            <div class="acoes-sorteio">
                <a href="{{ url_for('tela_sorteio', grupo_id=grupo.id) }}" class="btn btn-success btn-lg">
                    <i class="fas fa-random"></i> Realizar Meu Sorteio
                </a>
                <a href="{{ url_for('lista_sugestoes', grupo_id=grupo.id) }}" class="btn btn-secondary">
                    <i class="fas fa-gifts"></i> Ver Sugestões
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Lista de Participantes -->
    <div class="card participantes-card">
        <div class="card-header">
            <h2><i class="fas fa-user-friends"></i> Participantes ({{ membros|length }})</h2>
            {% if grupo.admin_id == current_user.id %}
            <button onclick="mostrarStatusSorteio()" class="btn btn-sm btn-info">
                <i class="fas fa-chart-bar"></i> Ver Status do Sorteio
            </button>
            {% endif %}
        </div>

        <div class="participantes-list">
            {% for membro in membros %}
            <div class="participante">
                <div class="participante-info">
                    <div class="avatar">{{ membro.usuario.nome[0]|upper }}</div>
                    <div>
                        <strong>{{ membro.usuario.nome }}</strong>
                        {% if membro.usuario_id == grupo.admin_id %}
                        <span class="badge badge-admin">Admin</span>
                        {% endif %}
                        <small>{{ membro.usuario.email }}</small>
                    </div>
                </div>

                <div class="participante-status">
                    {% set sorteio_membro = SorteioIndividual.query.filter_by(usuario_id=membro.usuario_id, grupo_id=grupo.id).first() %}
                    {% if sorteio_membro %}
                    <span class="status-sorteio status-realizado" title="Sorteio realizado em {{ sorteio_membro.data_sorteio.strftime('%d/%m/%Y %H:%M') }}">
                        <i class="fas fa-check-circle"></i> Já sorteou
                    </span>
                    {% else %}
                    <span class="status-sorteio status-pendente">
                        <i class="fas fa-clock"></i> Pendente
                    </span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Sugestões de Presentes (Preview) -->
    <div class="card sugestoes-preview">
        <div class="card-header">
            <h2><i class="fas fa-gifts"></i> Sugestões de Presentes</h2>
            <a href="{{ url_for('lista_sugestoes', grupo_id=grupo.id) }}" class="btn btn-primary">
                <i class="fas fa-external-link-alt"></i> Ver Todas
            </a>
        </div>

        <div class="sugestoes-list">
            {% if sugestoes %}
                {% for sugestao in sugestoes[:3] %}
                <div class="sugestao-item">
                    <div class="sugestao-descricao">
                        <p>{{ sugestao.descricao }}</p>
                        {% if sugestao.link %}
                        <a href="{{ sugestao.link }}" target="_blank" class="sugestao-link">
                            <i class="fas fa-external-link-alt"></i> Link
                        </a>
                        {% endif %}
                    </div>
                    <div class="sugestao-info">
                        <small>Por: {{ sugestao.usuario.nome }}</small>
                        <small>{{ sugestao.created_at.strftime('%d/%m') }}</small>
                    </div>
                </div>
                {% endfor %}

                {% if sugestoes|length > 3 %}
                <div class="ver-mais">
                    <a href="{{ url_for('lista_sugestoes', grupo_id=grupo.id) }}">
                        + {{ sugestoes|length - 3 }} mais sugestões...
                    </a>
                </div>
                {% endif %}
            {% else %}
            <div class="empty-sugestoes">
                <i class="fas fa-gift"></i>
                <p>Nenhuma sugestão adicionada ainda.</p>
                <a href="{{ url_for('lista_sugestoes', grupo_id=grupo.id) }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Adicionar Primeira Sugestão
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal para Status do Sorteio (apenas admin) -->
{% if grupo.admin_id == current_user.id %}
<div id="modalStatusSorteio" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-chart-bar"></i> Status do Sorteio</h3>
            <button onclick="fecharModal()" class="btn-close">&times;</button>
        </div>
        <div class="modal-body">
            <div id="statusLoading" class="loading">
                <i class="fas fa-spinner fa-spin"></i> Carregando status...
            </div>
            <div id="statusContent" style="display: none;">
                <div class="stats-summary">
                    <div class="stat-item">
                        <span class="stat-number" id="totalMembros">0</span>
                        <span class="stat-label">Total</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number text-success" id="sorteouCount">0</span>
                        <span class="stat-label">Já sortearam</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number text-warning" id="pendenteCount">0</span>
                        <span class="stat-label">Pendentes</span>
                    </div>
                </div>

                <div class="status-table-container">
                    <table class="status-table">
                        <thead>
                            <tr>
                                <th>Participante</th>
                                <th>Status</th>
                                <th>Data Sorteio</th>
                                <th>Amigo Sorteado</th>
                            </tr>
                        </thead>
                        <tbody id="statusTableBody">
                            <!-- Preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="fecharModal()" class="btn btn-secondary">Fechar</button>
            <button onclick="exportarStatus()" class="btn btn-primary">
                <i class="fas fa-download"></i> Exportar CSV
            </button>
        </div>
    </div>
</div>
{% endif %}

<style>
.grupo-container {
    max-width: 1200px;
    margin: 0 auto;
}

.grupo-header {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.grupo-header h1 {
    margin: 0;
    color: #2C3E50;
}

.codigo-grupo {
    background: #f8f9fa;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.btn-copiar {
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    padding: 5px;
    border-radius: 4px;
    transition: all 0.3s;
}

.btn-copiar:hover {
    background: #e9ecef;
    color: #333;
}

.badge-admin {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #333;
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Status do Meu Sorteio */
.meu-sorteio-status {
    margin: 20px 0;
    border-left: 5px solid var(--primary-color);
}

.sorteio-status-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.status-badge {
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.status-realizado {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-pendente {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.acoes-sorteio {
    display: flex;
    gap: 15px;
    margin-top: 20px;
}

/* Lista de Participantes */
.participantes-card {
    margin: 20px 0;
}

.participantes-list {
    max-height: 400px;
    overflow-y: auto;
}

.participante {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #eee;
    transition: background-color 0.3s;
}

.participante:hover {
    background-color: #f8f9fa;
}

.participante-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.avatar {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
}

.status-sorteio {
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 0.9rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

/* Sugestões Preview */
.sugestoes-preview {
    margin: 20px 0;
}

.sugestoes-list {
    margin-top: 15px;
}

.sugestao-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.sugestao-descricao {
    flex: 1;
}

.sugestao-link {
    display: inline-block;
    margin-top: 5px;
    color: #667eea;
    text-decoration: none;
    font-size: 0.9rem;
}

.sugestao-link:hover {
    text-decoration: underline;
}

.sugestao-info {
    text-align: right;
    font-size: 0.85rem;
    color: #666;
    min-width: 120px;
}

.sugestao-info small {
    display: block;
    margin-bottom: 3px;
}

.empty-sugestoes {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.empty-sugestoes i {
    font-size: 3rem;
    margin-bottom: 15px;
    color: #ddd;
}

.ver-mais {
    text-align: center;
    padding: 15px;
    border-top: 1px solid #eee;
}

.ver-mais a {
    color: #667eea;
    text-decoration: none;
}

.ver-mais a:hover {
    text-decoration: underline;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    width: 90%;
    max-width: 800px;
    border-radius: 10px;
    box-shadow: 0 5px 30px rgba(0,0,0,0.3);
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.btn-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
}

.modal-body {
    padding: 20px;
    max-height: 60vh;
    overflow-y: auto;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #666;
}

.stats-summary {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    justify-content: center;
}

.stat-item {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    min-width: 120px;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    display: block;
}

.stat-label {
    color: #666;
    font-size: 0.9rem;
}

.status-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.status-table th {
    background: #2C3E50;
    color: white;
    padding: 12px;
    text-align: left;
}

.status-table td {
    padding: 12px;
    border-bottom: 1px solid #eee;
}

.status-table tr:hover {
    background: #f5f5f5;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}
</style>

<script>
function copiarCodigo(codigo) {
    navigator.clipboard.writeText(codigo).then(() => {
        alert('Código copiado para a área de transferência!');
    });
}

{% if grupo.admin_id == current_user.id %}
let modal = document.getElementById('modalStatusSorteio');

function mostrarStatusSorteio() {
    modal.style.display = 'block';
    carregarStatusSorteio();
}

function fecharModal() {
    modal.style.display = 'none';
}

function carregarStatusSorteio() {
    const loading = document.getElementById('statusLoading');
    const content = document.getElementById('statusContent');
    const tableBody = document.getElementById('statusTableBody');

    loading.style.display = 'block';
    content.style.display = 'none';
    tableBody.innerHTML = '';

    fetch(`/api/grupo/{{ grupo.id }}/status-sorteio`)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            content.style.display = 'block';

            if (data.error) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center">${data.error}</td></tr>`;
                return;
            }

            // Atualizar estatísticas
            document.getElementById('totalMembros').textContent = data.grupo.total_membros;

            const sorteouCount = data.membros.filter(m => m.ja_sorteou).length;
            const pendenteCount = data.grupo.total_membros - sorteouCount;

            document.getElementById('sorteouCount').textContent = sorteouCount;
            document.getElementById('pendenteCount').textContent = pendenteCount;

            // Preencher tabela
            data.membros.forEach(membro => {
                const dataFormatada = membro.data_sorteio ?
                    new Date(membro.data_sorteio).toLocaleString('pt-BR') : 'Não sorteou';

                const statusClass = membro.ja_sorteou ? 'status-realizado' : 'status-pendente';
                const statusText = membro.ja_sorteou ? '✅ Já sorteou' : '⏳ Pendente';

                const amigoText = membro.amigo_sorteado || '-';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${membro.nome}</strong><br>
                        <small>${membro.email}</small>
                    </td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td>${dataFormatada}</td>
                    <td>${amigoText}</td>
                `;
                tableBody.appendChild(row);
            });
        })
        .catch(error => {
            loading.style.display = 'none';
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center">Erro ao carregar: ${error.message}</td></tr>`;
        });
}

function exportarStatus() {
    fetch(`/api/grupo/{{ grupo.id }}/status-sorteio`)
        .then(response => response.json())
        .then(data => {
            // Converter para CSV
            let csv = 'Nome,Email,Status,Data Sorteio,Amigo Sorteado\n';

            data.membros.forEach(membro => {
                const status = membro.ja_sorteou ? 'Já sorteou' : 'Pendente';
                const dataFormatada = membro.data_sorteio ?
                    new Date(membro.data_sorteio).toLocaleString('pt-BR') : '';
                const amigo = membro.amigo_sorteado || '';

                csv += `"${membro.nome}","${membro.email}","${status}","${dataFormatada}","${amigo}"\n`;
            });

            // Criar e baixar arquivo
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `status-sorteio-{{ grupo.nome }}-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
}

// Fechar modal ao clicar fora
window.onclick = function(event) {
    if (event.target == modal) {
        fecharModal();
    }
}
{% endif %}
</script>
{% endblock %}
