{% extends "base.html" %}

{% block title %}Sortear Amigo Secreto - {{ grupo.nome }}{% endblock %}

{% block content %}
<div class="sorteio-container">
    <div class="sorteio-header">
        <h1><i class="fas fa-random"></i> Sortear Amigo Secreto</h1>
        <p class="subtitle">Grupo: {{ grupo.nome }}</p>
        <a href="{{ url_for('ver_grupo', grupo_id=grupo.id) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar ao Grupo
        </a>
    </div>

    <div class="sorteio-card card">
        <div class="sorteio-instructions">
            <div class="instruction-item">
                <i class="fas fa-info-circle"></i>
                <div>
                    <h3>Como funciona:</h3>
                    <p>Clique no bot√£o abaixo para sortear aleatoriamente um amigo secreto entre os participantes do grupo.</p>
                    <p class="text-muted">Voc√™ s√≥ poder√° sortear uma vez por grupo.</p>
                </div>
            </div>

            <div class="instruction-item">
                <i class="fas fa-users"></i>
                <div>
                    <h3>Participantes dispon√≠veis:</h3>
                    <div class="participantes-preview">
                        {% for participante in participantes %}
                        <span class="participante-tag">{{ participante.nome }}</span>
                        {% endfor %}
                    </div>
                    <p class="text-muted">Total: {{ participantes|length }} participantes</p>
                </div>
            </div>
        </div>

        <div class="sorteio-actions">
            <button id="btnSortear" class="btn-sortear" onclick="iniciarSorteio()">
                <i class="fas fa-random"></i>
                <span>Sortear Meu Amigo Secreto</span>
            </button>

            <p class="text-warning">
                <i class="fas fa-exclamation-triangle"></i>
                Ap√≥s sortear, voc√™ n√£o poder√° sortear novamente!
            </p>
        </div>

        <div id="resultadoSorteio" class="resultado-sorteio" style="display: none;">
            <div class="resultado-header">
                <i class="fas fa-gift fa-3x"></i>
                <h2>üéâ Parab√©ns! üéâ</h2>
            </div>

            <div class="amigo-sorteado">
                <div class="amigo-info">
                    <div class="amigo-avatar" id="amigoAvatar">?</div>
                    <div class="amigo-detalhes">
                        <h3 id="amigoNome">Carregando...</h3>
                        <p id="amigoEmail"></p>
                    </div>
                </div>

                <div class="resultado-actions">
                    <button onclick="salvarSorteio()" class="btn btn-success btn-lg" id="btnSalvar">
                        <i class="fas fa-save"></i> Salvar Sorteio
                    </button>
                    <button onclick="sortearNovamente()" class="btn btn-secondary" id="btnSortearNovamente">
                        <i class="fas fa-redo"></i> Sortear Outro
                    </button>
                </div>

                <div class="lembrete">
                    <i class="fas fa-shield-alt"></i>
                    <p>Este resultado ser√° salvo e s√≥ voc√™ poder√° v√™-lo. N√£o conte para ningu√©m!</p>
                </div>
            </div>
        </div>

        <div id="loadingSorteio" class="loading-sorteio" style="display: none;">
            <div class="spinner"></div>
            <p>Sorteador...</p>
        </div>
    </div>

    <div class="sugestoes-card card">
        <h3><i class="fas fa-lightbulb"></i> Dicas para Presentear</h3>
        <div class="dicas-content">
            <p>Confira as sugest√µes de presentes dos participantes para ter ideias:</p>
            <a href="{{ url_for('lista_sugestoes', grupo_id=grupo.id) }}" class="btn btn-primary">
                <i class="fas fa-gifts"></i> Ver Sugest√µes de Presentes
            </a>
        </div>
    </div>
</div>

<style>
.sorteio-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.sorteio-header {
    text-align: center;
    margin-bottom: 30px;
}

.sorteio-header .subtitle {
    color: #666;
    font-size: 1.2rem;
    margin: 10px 0;
}

.sorteio-card {
    margin-bottom: 30px;
}

.sorteio-instructions {
    display: grid;
    gap: 25px;
    margin-bottom: 30px;
}

.instruction-item {
    display: flex;
    gap: 20px;
    align-items: flex-start;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    border-left: 4px solid var(--primary-color);
}

.instruction-item i {
    font-size: 1.5rem;
    color: var(--primary-color);
    margin-top: 5px;
}

.participantes-preview {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 10px 0;
}

.participante-tag {
    background: white;
    padding: 5px 12px;
    border-radius: 20px;
    border: 1px solid #ddd;
    font-size: 0.9rem;
}

.sorteio-actions {
    text-align: center;
    padding: 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    color: white;
}

.btn-sortear {
    background: white;
    color: #764ba2;
    border: none;
    padding: 20px 40px;
    font-size: 1.5rem;
    font-weight: bold;
    border-radius: 50px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 15px;
    transition: all 0.3s;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.btn-sortear:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}

.btn-sortear:active {
    transform: translateY(-1px);
}

.text-warning {
    margin-top: 20px;
    color: #FFD700;
}

.resultado-sorteio {
    margin-top: 30px;
    padding: 30px;
    background: white;
    border-radius: 15px;
    border: 2px solid #e9ecef;
}

.resultado-header {
    text-align: center;
    margin-bottom: 30px;
}

.resultado-header i {
    color: var(--primary-color);
    margin-bottom: 15px;
}

.amigo-sorteado {
    text-align: center;
}

.amigo-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    margin: 30px 0;
}

.amigo-avatar {
    width: 120px;
    height: 120px;
    background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    font-weight: bold;
}

.amigo-detalhes h3 {
    font-size: 2.5rem;
    margin: 10px 0;
    color: #2C3E50;
}

.amigo-detalhes p {
    color: #666;
    font-size: 1.1rem;
}

.resultado-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin: 30px 0;
}

.lembrete {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 15px;
    background: #fff3cd;
    border-radius: 10px;
    color: #856404;
    margin-top: 20px;
}

.lembrete i {
    font-size: 1.2rem;
}

.loading-sorteio {
    text-align: center;
    padding: 40px;
}

.spinner {
    border: 8px solid #f3f3f3;
    border-top: 8px solid var(--primary-color);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.sugestoes-card {
    text-align: center;
}

.dicas-content {
    padding: 20px;
}
</style>

<script>
let amigoSorteado = null;
let tokenSorteio = null;

function iniciarSorteio() {
    const btnSortear = document.getElementById('btnSortear');
    const loading = document.getElementById('loadingSorteio');
    const resultado = document.getElementById('resultadoSorteio');

    btnSortear.style.display = 'none';
    loading.style.display = 'block';

    // Simular anima√ß√£o de sorteio
    setTimeout(() => {
        realizarSorteio();
    }, 1500);
}

function realizarSorteio() {
    const loading = document.getElementById('loadingSorteio');
    const resultado = document.getElementById('resultadoSorteio');

    fetch(`/grupo/{{ grupo.id }}/realizar-sorteio`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        loading.style.display = 'none';

        if (data.error) {
            if (data.redirect) {
                window.location.href = data.redirect;
                return;
            }
            alert(data.error);
            window.location.href = "{{ url_for('ver_grupo', grupo_id=grupo.id) }}";
            return;
        }

        if (data.success) {
            amigoSorteado = data.amigo;
            tokenSorteio = data.token;

            // Mostrar resultado
            document.getElementById('amigoAvatar').textContent = amigoSorteado.nome[0];
            document.getElementById('amigoNome').textContent = amigoSorteado.nome;
            document.getElementById('amigoEmail').textContent = amigoSorteado.email;

            resultado.style.display = 'block';
        }
    })
    .catch(error => {
        loading.style.display = 'none';
        alert('Erro ao realizar sorteio. Tente novamente.');
        console.error('Error:', error);
    });
}

function salvarSorteio() {
    if (!amigoSorteado || !tokenSorteio) {
        alert('Erro: Nenhum sorteio para salvar!');
        return;
    }

    // Redirecionar para p√°gina de visualiza√ß√£o
    window.location.href = `/meu-sorteio/${tokenSorteio}`;
}

function sortearNovamente() {
    // S√≥ permitir se ainda n√£o salvou
    if (confirm('Tem certeza? Isso ir√° descartar o amigo sorteado atual.')) {
        document.getElementById('resultadoSorteio').style.display = 'none';
        document.getElementById('btnSortear').style.display = 'inline-flex';
    }
}

// Prevenir sa√≠da sem salvar
window.addEventListener('beforeunload', function (e) {
    const resultado = document.getElementById('resultadoSorteio');
    if (resultado.style.display === 'block') {
        e.preventDefault();
        e.returnValue = 'Voc√™ tem um sorteio n√£o salvo. Tem certeza que deseja sair?';
    }
});
</script>
{% endblock %}
